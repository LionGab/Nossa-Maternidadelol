# Cursor Rules - Nossa Maternidade

## Contexto do Projeto

Este √© um projeto fullstack TypeScript (React + Express) para uma plataforma de bem-estar materno criada por Nath√°lia Valente. O projeto usa:
- **Frontend**: React + Vite + Wouter + TanStack Query + shadcn/ui + Tailwind
- **Backend**: Express.js + Passport.js + Drizzle ORM + Neon PostgreSQL
- **Shared**: Tipos e schemas compartilhados (Zod + Drizzle)

## Padr√µes de C√≥digo Obrigat√≥rios

### TypeScript
- Sempre use tipos expl√≠citos, nunca `any`
- Importe tipos de `@shared/schema` para manter type safety
- Use path aliases: `@/` para `client/src/`, `@shared/` para `shared/`
- Strict mode est√° habilitado - siga as regras

### Backend (server/)
- **SEMPRE** valide inputs com Zod usando `validateBody`, `validateQuery`, `validateParams`
- **SEMPRE** use `requireAuth` para rotas protegidas
- **SEMPRE** use `logger` ao inv√©s de `console.log/error` (veja `server/logger.ts`)
- **SEMPRE** aplique rate limiting em rotas de AI (`aiChatLimiter`, `aiSearchLimiter`)
- Padr√£o de resposta: `res.json({ data: ... })` para sucesso, `res.status(400).json({ error: "..." })` para erro
- Acesse user ID via `req.user!.id` em rotas protegidas

### Frontend (client/)
- Use TanStack Query para server state, hooks locais para component state
- Componentes shadcn/ui est√£o em `client/src/components/ui/`
- Use `@/` para imports de `client/src/`
- Mobile-first: sempre pense em responsividade
- Use componentes existentes antes de criar novos

### Schemas e Valida√ß√£o
- Schemas Zod est√£o em `server/validation.ts`
- Schemas Drizzle est√£o em `shared/schema.ts`
- **NUNCA** aceite `authorName` manual em posts/comments - sempre pegue do perfil autenticado
- Use `generateAvatar()` de `server/avatar.ts` para avatares

### Performance
- Use pagina√ß√£o para listas grandes (`pagination.ts`)
- Evite N+1 queries - use batch loading quando poss√≠vel
- Cache Q&A responses por 7 dias (j√° implementado)

## Conven√ß√µes de Nomenclatura

- **Componentes React**: PascalCase (`Home.tsx`, `NathIA.tsx`)
- **Fun√ß√µes/utilities**: camelCase (`generateAvatar`, `validateBody`)
- **Tipos/Interfaces**: PascalCase (`UserStats`, `DailyFeatured`)
- **Arquivos**: kebab-case para configs, PascalCase para componentes
- **Rotas API**: `/api/*` prefix, kebab-case (`/api/daily-featured`)

## Estrutura de Arquivos

```
client/src/
  ‚îú‚îÄ‚îÄ pages/          # P√°ginas principais (rotas)
  ‚îú‚îÄ‚îÄ components/     # Componentes reutiliz√°veis
  ‚îÇ   ‚îú‚îÄ‚îÄ ui/        # Componentes shadcn/ui
  ‚îÇ   ‚îî‚îÄ‚îÄ landing/   # Componentes da landing page
  ‚îú‚îÄ‚îÄ hooks/         # Custom hooks
  ‚îî‚îÄ‚îÄ lib/           # Utilities e configura√ß√µes

server/
  ‚îú‚îÄ‚îÄ routes.ts      # Rotas principais da API
  ‚îú‚îÄ‚îÄ auth-routes.ts # Rotas de autentica√ß√£o
  ‚îú‚îÄ‚îÄ storage.ts     # Interface de storage (in-memory atual)
  ‚îú‚îÄ‚îÄ db.ts          # Drizzle ORM (preparado para migra√ß√£o)
  ‚îú‚îÄ‚îÄ validation.ts  # Schemas Zod
  ‚îú‚îÄ‚îÄ logger.ts      # Sistema de logging
  ‚îú‚îÄ‚îÄ rate-limit.ts  # Rate limiters
  ‚îî‚îÄ‚îÄ pagination.ts  # Utilit√°rios de pagina√ß√£o

shared/
  ‚îî‚îÄ‚îÄ schema.ts      # Schemas Drizzle + Zod (fonte √∫nica de verdade)
```

## Quando Usar Cursor vs Escalar para Claude Max

### Use Cursor ($20) para:
- ‚úÖ Edi√ß√µes r√°pidas e refatora√ß√µes simples
- ‚úÖ Corre√ß√µes de bugs pequenos
- ‚úÖ Adicionar novos campos a componentes existentes
- ‚úÖ Ajustes de UI/styling
- ‚úÖ Completar c√≥digo enquanto digita
- ‚úÖ Navega√ß√£o e busca no c√≥digo
- ‚úÖ Comandos do terminal integrados

### Escale para Claude Max ($100) quando:
- üî• Arquitetura complexa ou decis√µes de design
- üî• Refatora√ß√µes grandes (ex: migrar storage para Drizzle)
- üî• Otimiza√ß√µes de performance profundas
- üî• Planejamento de features grandes
- üî• Bugs dif√≠ceis que requerem an√°lise profunda
- üî• Revis√µes de c√≥digo complexas
- üî• Quando Cursor n√£o consegue resolver ap√≥s 2-3 tentativas

## Regras de Seguran√ßa

1. **SEMPRE** valide inputs do usu√°rio com Zod
2. **SEMPRE** use `requireAuth` em rotas que acessam dados do usu√°rio
3. **SEMPRE** aplique rate limiting em endpoints de AI
4. **NUNCA** exponha secrets em logs (logger j√° faz redaction autom√°tico)
5. **NUNCA** permita identity spoofing (sempre pegue `authorName` do perfil autenticado)

## Gamifica√ß√£o

- Cada h√°bito completado = +10 XP
- Level = `Math.floor(xp / 100) + 1`
- Streaks s√£o rastreados em `userStats.currentStreak`
- Achievements desbloqueiam automaticamente (veja `server/routes.ts:345-371`)

## Logging

- Use `logger.info({ msg: "...", ...context })` para info
- Use `logger.error({ msg: "...", err, ...context })` para erros
- Use `logAICall()` e `logDbOperation()` para opera√ß√µes espec√≠ficas
- Logger redacta automaticamente passwords, tokens, API keys

## Comandos √öteis

```bash
npm run dev          # Dev server (localhost:5000)
npm run build        # Build produ√ß√£o
npm run check        # Type check
npm run db:push      # Push schema para DB
```

## Notas Importantes

- Storage atual √© in-memory (reseta no restart) - migra√ß√£o para Drizzle est√° planejada
- Windows compatibility: server usa `localhost` ao inv√©s de `0.0.0.0`
- Q&A responses s√£o cacheadas por 7 dias para reduzir custos de API
- Session secret deve ter >= 32 chars em produ√ß√£o

## Prioridades do Projeto

1. Migrar storage in-memory para Drizzle ORM (PostgreSQL)
2. Gerar migrations versionadas ao inv√©s de `db:push`
3. Adicionar testes (Vitest)
4. Redis cache para Q&A e habit completions
5. Monitoring (Prometheus + Grafana)

