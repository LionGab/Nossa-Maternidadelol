# Edge Functions - Nossa Maternidade

## Visão Geral

Edge Functions do Supabase para processar requisições do app, incluindo chat com IA, moderação, análise de risco e compliance LGPD.

## Lista de Edge Functions

### 1. nathia-chat

**Função**: Chat principal com NathIA usando Gemini 2.0 Flash

**Endpoint**: `POST /functions/v1/nathia-chat`

**Request**:

```json
{
  "message": "Oi NathIA, estou me sentindo ansiosa hoje...",
  "userId": "user-uuid"
}
```

**Response**:

```json
{
  "response": "Oi querida! Entendo sua ansiedade...",
  "rateLimit": {
    "remaining": 29
  }
}
```

**Recursos**:

- Rate limiting (30 req/min por usuário)
- Busca contexto (últimas 20 mensagens + perfil)
- Salvamento automático no Supabase
- Safety settings do Gemini configurados

**Secrets Necessários**:

- `GEMINI_API_KEY`

---

### 2. moderation-service

**Função**: Moderação em 3 camadas de conteúdo

**Endpoint**: `POST /functions/v1/moderation-service`

**Request**:

```json
{
  "message": "mensagem do usuário",
  "userId": "user-uuid"
}
```

**Response**:

```json
{
  "safe": true,
  "category": "safe",
  "severity": 0,
  "action": "allow"
}
```

**Camadas de Moderação**:

1. **Safety Settings** (Gemini) - Verificação instantânea
2. **Análise Contextual** (Gemini) - Análise profunda
3. **Flag Queue** (Supabase) - Revisão humana

**Secrets Necessários**:

- `GEMINI_API_KEY`

---

### 3. risk-classifier

**Função**: Classificação de risco emocional

**Endpoint**: `POST /functions/v1/risk-classifier`

**Request**:

```json
{
  "message": "mensagem do usuário",
  "userId": "user-uuid"
}
```

**Response**:

```json
{
  "level": 5,
  "flags": ["burnout"],
  "requires_intervention": false,
  "suggested_resources": ["therapy"]
}
```

**Níveis de Risco**:

- 0-2: Normal
- 3-4: Estresse elevado
- 5-6: Sobrecarga significativa
- 7-8: Depressão/ansiedade clínica
- 9-10: CRISE

**Secrets Necessários**:

- `ANTHROPIC_API_KEY` (opcional, usa fallback se não configurado)

---

### 4. behavior-analysis

**Função**: Análise de comportamento para melhorar respostas

**Endpoint**: `POST /functions/v1/behavior-analysis`

**Recursos**:

- Análise de padrões de comportamento
- Identificação de tendências
- Melhoria contínua do sistema de IA

---

### 5. lgpd-requests

**Função**: Compliance LGPD - exportação e exclusão de dados

**Endpoint**: `POST /functions/v1/lgpd-requests`

**Request**:

```json
{
  "action": "export" | "delete",
  "userId": "user-uuid"
}
```

**Recursos**:

- Exportação de dados do usuário
- Exclusão completa de dados
- Conformidade com LGPD

---

### 6. transcribe-audio

**Função**: Transcrição de áudio para chat por voz

**Endpoint**: `POST /functions/v1/transcribe-audio`

**Request**:

```json
{
  "audio": "base64-encoded-audio",
  "userId": "user-uuid"
}
```

**Response**:

```json
{
  "transcription": "texto transcrito do áudio"
}
```

---

## Deploy das Edge Functions

### Via Supabase CLI

```bash
# Instalar Supabase CLI
npm install -g supabase

# Login no Supabase
supabase login

# Link com projeto
supabase link --project-ref seu-project-ref

# Deploy individual
supabase functions deploy nathia-chat
supabase functions deploy moderation-service
supabase functions deploy risk-classifier
supabase functions deploy behavior-analysis
supabase functions deploy lgpd-requests
supabase functions deploy transcribe-audio

# Deploy todas de uma vez
supabase functions deploy
```

### Configurar Secrets

No Supabase Dashboard → Edge Functions → Secrets:

- `GEMINI_API_KEY` - Para nathia-chat e moderation-service
- `ANTHROPIC_API_KEY` - Para risk-classifier
- `SUPABASE_URL` - Para todas as funções
- `SUPABASE_SERVICE_ROLE_KEY` - Para todas as funções

## Testar Localmente

```bash
# Iniciar Supabase local
supabase start

# Servir Edge Functions localmente
supabase functions serve

# Testar função específica
curl -X POST http://localhost:54321/functions/v1/nathia-chat \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{"message": "teste"}'
```

## Monitoramento

### Logs

```bash
# Ver logs de uma função
supabase functions logs nathia-chat

# Ver logs em tempo real
supabase functions logs nathia-chat --follow
```

### Dashboard

Acesse o Supabase Dashboard → Edge Functions para ver:

- Métricas de uso
- Logs de erros
- Performance

## Troubleshooting

### Função não responde

1. Verificar logs no Supabase Dashboard
2. Verificar secrets configurados
3. Testar localmente

### Erro de autenticação

1. Verificar token JWT no header
2. Verificar RLS policies
3. Verificar service role key

### Rate limiting

1. Verificar limites configurados
2. Implementar retry com backoff
3. Monitorar uso por usuário
